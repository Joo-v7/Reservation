<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.home.pg.service.impl.PgHomeMemberMapper">

    <!-- 회원 - 총 인원 -->
    <select id="getMemberTotalCnt" parameterType="hashMap" resultType="Double">
        SELECT COUNT(*)
        FROM MEMBER m
        <where>
            <if test='searchStatus != null and searchStatus != ""'>
                AND m.status = #{searchStatus, jdbcType=VARCHAR}
            </if>
            <if test='searchQuery != null and searchQuery != ""'>
                AND m.name LIKE CONCAT('%', #{searchQuery, jdbcType=VARCHAR}, '%')
            </if>
        </where>
    </select>

    <!-- 회원 - 리스트 -->
    <select id="getMemberList" parameterType="hashMap" resultType="egovMap">
        SELECT
            m.member_id,
            m.username,
            m.password,
            m.name,
            m.phone,
            m.email,
            m.birthdate,
            m.status,
            m.is_oauth,
            m.oauth_provider,
            m.reg_dt,
            m.updt_dt,
            m.del_dt,
            m.last_logined,
            IFNULL(GROUP_CONCAT(DISTINCT r.description ORDER BY r.description SEPARATOR ','), '') AS role
        FROM MEMBER m
        LEFT JOIN MEMBER_ROLE mr ON mr.member_id = m.member_id
        LEFT JOIN ROLE r ON r.role_id = mr.role_id
        <where>
            <if test='searchStatus != null and searchStatus != ""'>
                AND m.status = #{searchStatus, jdbcType=VARCHAR}
            </if>
            <if test='searchQuery != null and searchQuery != ""'>
                AND m.name LIKE CONCAT('%', #{searchQuery, jdbcType=VARCHAR}, '%')
            </if>
        </where>
        GROUP BY m.member_id
        ORDER BY m.reg_dt DESC
        LIMIT #{limitStart, jdbcType=INTEGER}, #{recordCnt, jdbcType=INTEGER}
    </select>

    <!-- 회원 - 단일 조회 by ID -->
    <select id="getMemberById" parameterType="Long" resultType="egovMap">
        SELECT
            m.member_id,
            m.username,
            m.password,
            m.name,
            m.phone,
            m.email,
            m.birthdate,
            m.status,
            m.is_oauth,
            m.oauth_provider,
            m.reg_dt,
            m.updt_dt,
            m.del_dt,
            m.last_logined,
            IFNULL(GROUP_CONCAT(DISTINCT r.role_id ORDER BY r.role_id SEPARATOR ','), '') AS role

        FROM MEMBER m
                 LEFT JOIN MEMBER_ROLE mr ON mr.member_id = m.member_id
                 LEFT JOIN ROLE r ON r.role_id = mr.role_id
        WHERE m.member_id = #{memberId, jdbcType=INTEGER}
    </select>

    <!-- 회원 - 단일 조회 by USERNAME -->
    <select id="getMemberByUsername" parameterType="String" resultType="egovMap">
        SELECT
            m.member_id,
            m.username,
            m.password,
            m.name,
            m.phone,
            m.email,
            m.birthdate,
            m.status,
            m.is_oauth,
            m.oauth_provider,
            m.reg_dt,
            m.updt_dt,
            m.del_dt,
            m.last_logined,
            IFNULL(GROUP_CONCAT(DISTINCT r.name ORDER BY r.name SEPARATOR ','), '') AS role

        FROM MEMBER m
        LEFT JOIN MEMBER_ROLE mr ON mr.member_id = m.member_id
        LEFT JOIN ROLE r ON r.role_id = mr.role_id
        WHERE m.username = #{username, jdbcType=VARCHAR}
    </select>

    <!-- 회원 - Merge -->
    <insert id="setMemberMerge" parameterType="hashMap" useGeneratedKeys="true" keyProperty="memberId">
        INSERT INTO MEMBER
        (
         username,
         password,
         name,
         phone,
         email,
         birthdate,
         <if test="isOauth != null and isOauth !=''">
             is_oauth,
         </if>
        <if test="oauthProvider != null and oauthProvider !=''">
            oauth_provider,
        </if>
         reg_dt
        )
        VALUES
            (
             #{username, jdbcType=VARCHAR},
             #{password, jdbcType=VARCHAR},
             #{name, jdbcType=VARCHAR},
             #{phone, jdbcType=VARCHAR},
             #{email, jdbcType=VARCHAR},
             #{birthdate, jdbcType=DATE},
            <if test="isOauth != null and isOauth !=''">
                #{isOauth, jdbcType=CHAR},
            </if>
            <if test="oauthProvider != null and oauthProvider !=''">
                #{oauthProvider, jdbcType=VARCHAR},
            </if>
             NOW()
            )
        ON DUPLICATE KEY UPDATE
            <if test="name != null and name != ''">
                name = #{name, jdbcType=VARCHAR},
            </if>
            <if test="phone != null and phone != ''">
                phone = #{phone, jdbcType=VARCHAR},
            </if>
            <if test="email != null and email != ''">
                email = #{email, jdbcType=VARCHAR},
            </if>
            <if test="birthdate != null and birthdate != ''">
                birthdate = #{birthdate, jdbcType=DATE},
            </if>
            <if test="status != null and status != ''">
                status = #{status, jdbcType=VARCHAR},
            </if>
            updt_dt = NOW()
    </insert>

    <!-- 회원의 status 조회 -->
    <select id="getMemberStatusByUsername" parameterType="hashMap" resultType="java.lang.String">
        SELECT status
        FROM MEMBER
        WHERE USERNAME = #{username, jdbcType=VARCHAR}
    </select>

    <!-- 회원의 username(LoginID) 존재 여부 확인 --> 
    <select id="existsByUsername" parameterType="String">
        SELECT EXISTS (
            SELECT 1
            FROM MEMBER
            WHERE USERNAME = #{username, jdbcType=VARCHAR}
        )
    </select>

    <!-- 회원 최근 로그인 일시 업데이트 -->
    <update id="setUpdateLastLoginAtByUsername" parameterType="String">
        UPDATE MEMBER
        SET last_logined = NOW()
        WHERE username = #{username, jdbcType=VARCHAR}
    </update>

    <!-- 회원 수정 -->
    <update id="setMemberUpdate" parameterType="hashMap">
        UPDATE MEMBER
        <set>
            <if test="password != null and password != ''">password = #{password, jdbcType=VARCHAR},</if>
            <if test="name != null and name != ''">name = #{name, jdbcType=VARCHAR},</if>
            <if test="phone != null and phone != ''">phone = #{phone, jdbcType=VARCHAR},</if>
            <if test="email != null and email != ''">email = #{email, jdbcType=VARCHAR},</if>
            <if test="birthdate != null and birthdate != ''">birthdate = #{birthdate, jdbcType=DATE},</if>
            <if test="status != null and status != ''">status = #{status, jdbcType=VARCHAR},</if>
            <if test="status == 'DELETED'">del_dt = NOW(),</if>
            updt_dt = NOW()
        </set>
        WHERE member_id = #{memberId, jdbcType=INTEGER}
    </update>



</mapper>
